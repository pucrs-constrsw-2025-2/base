networks:
  constrsw:

volumes:
  # No terminal, criar o volume externo: docker volume create constrsw-prometheus-data
  constrsw-prometheus-data:
    external: true
  # No terminal, criar o volume externo: docker volume create constrsw-keycloak-data
  constrsw-keycloak-data:
    external: true
  # No terminal, criar o volume externo: docker volume create constrsw-postgresql-data
  constrsw-postgresql-data:
    external: true
  # No terminal, criar o volume externo: docker volume create constrsw-mongodb-data
  constrsw-mongodb-data:
    external: true
  # No terminal, criar os volumes externos: docker volume create constrsw-sonarqube-data && docker volume create constrsw-sonarqube-extensions && docker volume create constrsw-sonarqube-logs
  constrsw-sonarqube-data:
    external: true
  constrsw-sonarqube-extensions:
    external: true
  constrsw-sonarqube-logs:
    external: true

services:
  # OpenTelemetry Collector
  otel-collector:
    container_name: otel-collector
    build:
      context: ./backend/utils/otel-collector
      dockerfile: Dockerfile
    image: constrsw/otel-collector
    command: ["--config=/etc/otelcol/config.yaml"]
    volumes:
      - ./backend/utils/otel-collector/otel-collector-config.yml:/etc/otelcol/config.yaml
    ports:
      - "4317:4317"   # OTLP gRPC receiver
      - "4318:4318"   # OTLP HTTP receiver
      - "8888:8888"   # Prometheus metrics endpoint
      - "8889:8889"   # Prometheus exporter
    networks:
      - constrsw
    depends_on:
      - prometheus
    restart: always

  # Prometheus
  prometheus:
    container_name: prometheus
    build:
      context: ./backend/utils/prometheus
      dockerfile: Dockerfile
    image: constrsw/prometheus
    environment:
      - PROMETHEUS_INTERNAL_HOST=${PROMETHEUS_INTERNAL_HOST}
      - PROMETHEUS_EXTERNAL_HOST=${PROMETHEUS_EXTERNAL_HOST}
      - PROMETHEUS_INTERNAL_PORT=${PROMETHEUS_INTERNAL_PORT}
      - PROMETHEUS_EXTERNAL_PORT=${PROMETHEUS_EXTERNAL_PORT}
    volumes:
      - constrsw-prometheus-data:/prometheus
      - ./backend/utils/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./backend/utils/prometheus/alerts.yml:/etc/prometheus/alerts.yml
    networks:
      - constrsw
    ports:
      - ${PROMETHEUS_EXTERNAL_PORT}:${PROMETHEUS_INTERNAL_PORT}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: always

  # Blackbox Exporter (para monitoramento de health checks)
  blackbox-exporter:
    container_name: blackbox-exporter
    image: prom/blackbox-exporter:latest
    volumes:
      - ./backend/utils/prometheus/blackbox.yml:/etc/blackbox_exporter/config.yml
    networks:
      - constrsw
    ports:
      - "9115:9115"
    restart: always

  # PostgreSQL
  postgresql:
    container_name: postgresql
    build:
      context: ./backend/utils/postgresql/
      dockerfile: Dockerfile
      args:
        POSTGRESQL_HOST_AUTH_METHOD: ${POSTGRESQL_HOST_AUTH_METHOD}
        POSTGRESQL_DATA: ${POSTGRESQL_DATA}
        POSTGRESQL_USERNAME: ${POSTGRESQL_USERNAME}
        POSTGRESQL_PASSWORD: ${POSTGRESQL_PASSWORD}
    image: constrsw/postgresql
    environment:
      - POSTGRESQL_INTERNAL_HOST=${POSTGRESQL_INTERNAL_HOST}
      - POSTGRESQL_INTERNAL_PORT=${POSTGRESQL_INTERNAL_PORT}
      - POSTGRES_USER=${POSTGRESQL_USERNAME}
      - POSTGRES_PASSWORD=${POSTGRESQL_PASSWORD}
      - POSTGRESQL_DB=${POSTGRESQL_DB}
    volumes:
      # No terminal, criar o volume externo: docker volume create constrsw-postgresql-data
      - constrsw-postgresql-data:${POSTGRESQL_DATA}
    networks:
      - constrsw
    ports:
      - ${POSTGRESQL_EXTERNAL_PORT}:${POSTGRESQL_INTERNAL_PORT}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRESQL_USERNAME}"]
      start_period: 0s
      interval: 10s
      timeout: 10s
      retries: 10
    restart: always

  # PostgreSQL Exporter para o Prometheus
  postgresql-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: postgresql-exporter
    environment:
      - DATA_SOURCE_NAME=postgresql://${POSTGRESQL_USERNAME}:${POSTGRESQL_PASSWORD}@${POSTGRESQL_INTERNAL_HOST}:${POSTGRESQL_INTERNAL_PORT}/${POSTGRESQL_DB}?sslmode=disable
    ports:
      - "9187:9187"
    networks:
      - constrsw
    depends_on:
      - postgresql

  # MongoDB
  mongodb:
    container_name: mongodb
    build:
      context: ./backend/utils/mongodb/
      dockerfile: Dockerfile
      args:
        - MONGO_INITDB_ROOT_USERNAME=${MONGODB_USERNAME}
        - MONGO_INITDB_ROOT_PASSWORD=${MONGODB_PASSWORD}
    image: constrsw/mongodb
    environment:
      - MONGODB_USERNAME=${MONGODB_USERNAME}
      - MONGODB_PASSWORD=${MONGODB_PASSWORD}
      - MONGODB_INTERNAL_HOST=${MONGODB_INTERNAL_HOST}
      - MONGODB_INTERNAL_PORT=${MONGODB_INTERNAL_PORT}
    volumes:
      # No terminal, criar o volume externo: docker volume create constrsw-mongodb-data
      - constrsw-mongodb-data:/data/mongodb
    networks:
      - constrsw
    ports:
      - ${MONGODB_EXTERNAL_PORT}:${MONGODB_INTERNAL_PORT}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "mongosh --quiet mongodb://${MONGODB_USERNAME}:${MONGODB_PASSWORD}@${MONGODB_INTERNAL_HOST}:${MONGODB_INTERNAL_PORT}/constrsw --eval 'quit(db.runCommand({ ping: 1 }).ok ? 0 : 2)'",
        ]
      start_period: 0s
      interval: 20s
      timeout: 10s
      retries: 20
    restart: always

  # MongoDB Exporter para o Prometheus
  mongodb-exporter:
    image: percona/mongodb_exporter:0.40.0
    container_name: mongodb-exporter
    environment:
      - MONGODB_URI=mongodb://${MONGODB_USERNAME}:${MONGODB_PASSWORD}@${MONGODB_INTERNAL_HOST}:${MONGODB_INTERNAL_PORT}
    ports:
      - "9216:9216"
    networks:
      - constrsw
    depends_on:
      - mongodb

  # SonarQube
  sonarqube:
    container_name: sonarqube
    build:
      context: ./backend/utils/sonarqube/
      dockerfile: Dockerfile
    image: constrsw/sonarqube
    environment:
      - SONAR_WEB_HOST=${SONAR_WEB_HOST}
      - SONAR_WEB_PORT=${SONAR_WEB_PORT}
      - SONAR_WEB_CONTEXT=${SONAR_WEB_CONTEXT}
      - SONAR_JDBC_URL=jdbc:postgresql://${POSTGRESQL_INTERNAL_HOST}:${POSTGRESQL_INTERNAL_PORT}/sonar
      - SONAR_JDBC_USERNAME=${POSTGRESQL_USERNAME}
      - SONAR_JDBC_PASSWORD=${POSTGRESQL_PASSWORD}
      - SONARQUBE_USER=${SONARQUBE_USER}
      - SONARQUBE_PASSWORD=${SONARQUBE_PASSWORD}
    volumes:
      # No terminal, criar o volume externo: docker volume create constrsw-sonarqube-data
      - constrsw-sonarqube-data:/opt/sonarqube/data
      # No terminal, criar o volume externo: docker volume create constrsw-sonarqube-extensions
      - constrsw-sonarqube-extensions:/opt/sonarqube/extensions
      # No terminal, criar o volume externo: docker volume create constrsw-sonarqube-logs
      - constrsw-sonarqube-logs:/opt/sonarqube/logs
    networks:
      - constrsw
    ports:
      - ${SONAR_WEB_PORT}:${SONAR_WEB_PORT}
    depends_on:
      postgresql:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -f ${SONARQUBE_INTERNAL_PROTOCOL}://${SONARQUBE_INTERNAL_HOST}:${SONARQUBE_INTERNAL_PORT}/api/system/status || exit 1",
        ]
      start_period: 0s
      interval: 30s
      timeout: 10s
      retries: 10
    restart: always

  # Keycloak
  keycloak:
    container_name: keycloak
    build:
      context: backend/utils/keycloak
      dockerfile: Dockerfile
    image: constrsw/keycloak
    environment:
      - KC_HEALTH_ENABLED=${KC_HEALTH_ENABLED}
      - KC_METRICS_ENABLED=${KC_METRICS_ENABLED}
      - KC_HTTP_MANAGEMENT_PORT=${KC_HTTP_MANAGEMENT_PORT}
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD}
    volumes:
      # No terminal, criar o volume externo: docker volume create constrsw-keycloak-data
      - constrsw-keycloak-data:/opt/keycloak/data
      - ./backend/utils/keycloak:/opt/keycloak/data/import
    networks:
      - constrsw
    ports:
      - ${KEYCLOAK_EXTERNAL_CONSOLE_PORT}:${KEYCLOAK_INTERNAL_CONSOLE_PORT}
      - ${KEYCLOAK_EXTERNAL_METRICS_PORT}:${KEYCLOAK_INTERNAL_METRICS_PORT}
    command: start-dev --import-realm
    restart: always
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -f ${KEYCLOAK_INTERNAL_HOST}:${KEYCLOAK_INTERNAL_METRICS_PORT}/health",
        ]
      start_period: 0s
      interval: 20s
      timeout: 10s
      retries: 20

  # OAuth API
  oauth:
    container_name: oauth
    build:
      context: ./backend/oauth # Diretório que contém o Dockerfile da API
      dockerfile: Dockerfile
    image: constrsw/oauth
    environment:
      - KEYCLOAK_SERVER_URL=${KEYCLOAK_SERVER_URL}
      - KEYCLOAK_REALM=${KEYCLOAK_REALM}
      - KEYCLOAK_CLIENT_ID=${KEYCLOAK_CLIENT_ID}
      - KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET}
      - OTEL_SERVICE_NAME=oauth
      # Debug Configuration for Python
      - PYTHON_DEBUG_ENABLED=${PYTHON_DEBUG_ENABLED:-true}
      - PYTHON_DEBUG_WAIT=${PYTHON_DEBUG_WAIT:-false}
    ports:
      - ${OAUTH_EXTERNAL_API_PORT}:${OAUTH_INTERNAL_API_PORT}
      - ${OAUTH_EXTERNAL_DEBUG_PORT}:${OAUTH_INTERNAL_DEBUG_PORT}  # Porta de debug remoto para depuração passo-a-passo
    networks:
      - constrsw
    volumes:
      # Monta o código-fonte da API dentro do contêiner para que o --reload funcione
      - ./backend/oauth:/app
    depends_on:
      keycloak:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${OAUTH_INTERNAL_API_PORT}/api/v1/health || exit 1"]
      start_period: 30s
      interval: 10s
      timeout: 10s
      retries: 10
    command: >
      sh -c "
      if [ \"$$PYTHON_DEBUG_ENABLED\" = \"true\" ]; then
        if [ \"$$PYTHON_DEBUG_WAIT\" = \"true\" ]; then
          python -m debugpy --listen 0.0.0.0:${OAUTH_INTERNAL_DEBUG_PORT} --wait-for-client -m uvicorn src.main:app --host 0.0.0.0 --port ${OAUTH_INTERNAL_API_PORT} --reload
        else
          python -m debugpy --listen 0.0.0.0:${OAUTH_INTERNAL_DEBUG_PORT} -m uvicorn src.main:app --host 0.0.0.0 --port ${OAUTH_INTERNAL_API_PORT} --reload
        fi
      else
        uvicorn src.main:app --host 0.0.0.0 --port ${OAUTH_INTERNAL_API_PORT} --reload
      fi
      "

  # Employees API
  employees:
    container_name: employees
    build:
      context: ./backend/employees/
      dockerfile: Dockerfile
    image: constrsw/employees
    environment:
      - MONGODB_HOST=${MONGODB_INTERNAL_HOST}
      - MONGODB_PORT=${MONGODB_INTERNAL_PORT}
      - MONGODB_USERNAME=${EMPLOYEES_MONGODB_USERNAME}
      - MONGODB_PASSWORD=${EMPLOYEES_MONGODB_PASSWORD}
      - MONGODB_DATABASE=${EMPLOYEES_MONGODB_DB}
      - OAUTH_INTERNAL_PROTOCOL=${OAUTH_INTERNAL_PROTOCOL}
      - OAUTH_INTERNAL_HOST=${OAUTH_INTERNAL_HOST}
      - OAUTH_INTERNAL_API_PORT=${OAUTH_INTERNAL_API_PORT}
      - OTEL_SERVICE_NAME=employees
      # OpenTelemetry OTLP Exporter Configuration
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
      - OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf
      # Debug Configuration
      - JAVA_DEBUG_ENABLED=${JAVA_DEBUG_ENABLED:-true}
      - JAVA_DEBUG_SUSPEND=${JAVA_DEBUG_SUSPEND:-n}
    networks:
      - constrsw
    ports:
      - ${EMPLOYEES_EXTERNAL_API_PORT}:${EMPLOYEES_INTERNAL_API_PORT}
      - ${EMPLOYEES_EXTERNAL_DEBUG_PORT}:${EMPLOYEES_INTERNAL_DEBUG_PORT}  # Porta de debug remoto para depuração passo-a-passo
    command: >
      sh -c "
      if [ \"$$JAVA_DEBUG_ENABLED\" = \"true\" ]; then
        java -agentlib:jdwp=transport=dt_socket,server=y,suspend=$$JAVA_DEBUG_SUSPEND,address=*:${EMPLOYEES_INTERNAL_DEBUG_PORT} -jar app.jar
      else
        java -jar app.jar
      fi
      "
    depends_on:
      mongodb:
        condition: service_healthy
      otel-collector:
        condition: service_started
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/api/v1/health || exit 1"]
      start_period: 40s
      interval: 10s
      timeout: 10s
      retries: 10

  # Classes API (ClasseMicroservice)
  classes:
    container_name: classes
    build:
      context: ./backend/classes/ClasseMicroservice
      dockerfile: Dockerfile
    image: constrsw/classes
    environment:
      - MONGODB_HOST=${MONGODB_INTERNAL_HOST}
      - MONGODB_PORT=${MONGODB_INTERNAL_PORT}
      - MONGODB_USERNAME=${CLASSES_MONGODB_USERNAME}
      - MONGODB_PASSWORD=${CLASSES_MONGODB_PASSWORD}
      - MONGODB_DATABASE=${CLASSES_MONGODB_DB}
      - OAUTH_INTERNAL_PROTOCOL=${OAUTH_INTERNAL_PROTOCOL}
      - OAUTH_INTERNAL_HOST=${OAUTH_INTERNAL_HOST}
      - OAUTH_INTERNAL_API_PORT=${OAUTH_INTERNAL_API_PORT}
      - ENABLE_SWAGGER=${ENABLE_SWAGGER}
      - OTEL_SERVICE_NAME=classes
      # Debug Configuration for .NET
      - DOTNET_DBG_ENABLE=${DOTNET_DBG_ENABLE:-1}
      - DOTNET_DBG_PORT=${CLASSES_INTERNAL_DEBUG_PORT}
    networks:
      - constrsw
    ports:
      - ${CLASSES_EXTERNAL_API_PORT}:${CLASSES_INTERNAL_API_PORT}
      - ${CLASSES_EXTERNAL_DEBUG_PORT}:${CLASSES_INTERNAL_DEBUG_PORT}  # Porta de debug remoto para depuração passo-a-passo
    command: >
      sh -c "
      if [ \"$$DOTNET_DBG_ENABLE\" = \"1\" ]; then
        export DOTNET_DBG_ENABLE=1
        export DOTNET_DBG_PORT=$${CLASSES_INTERNAL_DEBUG_PORT}
        dotnet ClasseMicroservice.API.dll
      else
        dotnet ClasseMicroservice.API.dll
      fi
      "
    depends_on:
      mongodb:
        condition: service_healthy
      oauth:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -f ${CLASSES_INTERNAL_PROTOCOL}://${CLASSES_INTERNAL_HOST}:${CLASSES_INTERNAL_API_PORT}/api/v1/health || exit 1"]
      start_period: 40s
      interval: 10s
      timeout: 10s
      retries: 10

  # Courses API
  courses:
    container_name: courses
    build:
      context: ./backend/courses/
      dockerfile: Dockerfile
    image: constrsw/courses
    environment:
      - MONGODB_HOST=${MONGODB_INTERNAL_HOST}
      - MONGODB_PORT=${MONGODB_INTERNAL_PORT}
      - MONGODB_USER=${COURSES_MONGODB_USERNAME}
      - MONGODB_PASSWORD=${COURSES_MONGODB_PASSWORD}
      - MONGODB_DB=${COURSES_MONGODB_DB}
      - OAUTH_INTERNAL_PROTOCOL=${OAUTH_INTERNAL_PROTOCOL}
      - OAUTH_INTERNAL_HOST=${OAUTH_INTERNAL_HOST}
      - OAUTH_INTERNAL_API_PORT=${OAUTH_INTERNAL_API_PORT}
      - CLASSES_API_BASE_URL=${CLASSES_INTERNAL_PROTOCOL}://${CLASSES_INTERNAL_HOST}:${CLASSES_INTERNAL_API_PORT}
      - MONGO_URI=mongodb://${COURSES_MONGODB_USERNAME}:${COURSES_MONGODB_PASSWORD}@${MONGODB_INTERNAL_HOST}:${MONGODB_INTERNAL_PORT}/${COURSES_MONGODB_DB}
      - DATABASE_NAME=${COURSES_MONGODB_DB}
      - OTEL_SERVICE_NAME=courses
      # Debug Configuration for Python
      - PYTHON_DEBUG_ENABLED=${PYTHON_DEBUG_ENABLED:-true}
      - PYTHON_DEBUG_WAIT=${PYTHON_DEBUG_WAIT:-false}
    networks:
      - constrsw
    ports:
      - ${COURSES_EXTERNAL_API_PORT}:${COURSES_INTERNAL_API_PORT}
      - ${COURSES_EXTERNAL_DEBUG_PORT}:${COURSES_INTERNAL_DEBUG_PORT}  # Porta de debug remoto para depuração passo-a-passo
    command: >
      sh -c "
      if [ \"$$PYTHON_DEBUG_ENABLED\" = \"true\" ]; then
        if [ \"$$PYTHON_DEBUG_WAIT\" = \"true\" ]; then
          python -m debugpy --listen 0.0.0.0:${COURSES_INTERNAL_DEBUG_PORT} --wait-for-client -m uvicorn main:app --host 0.0.0.0 --port 8080
        else
          python -m debugpy --listen 0.0.0.0:${COURSES_INTERNAL_DEBUG_PORT} -m uvicorn main:app --host 0.0.0.0 --port 8080
        fi
      else
        uvicorn main:app --host 0.0.0.0 --port 8080
      fi
      "
    depends_on:
      mongodb:
        condition: service_healthy
      oauth:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -f ${COURSES_INTERNAL_PROTOCOL}://${COURSES_INTERNAL_HOST}:${COURSES_INTERNAL_API_PORT}/api/v1/health || exit 1"]
      start_period: 40s
      interval: 10s
      timeout: 10s
      retries: 10
      
  # Lessons API
  lessons:
    container_name: lessons
    build:
      context: ./backend/lessons
      dockerfile: Dockerfile
    image: constrsw/lessons
    environment:
      - POSTGRESQL_HOST=${POSTGRESQL_INTERNAL_HOST}
      - POSTGRESQL_PORT=${POSTGRESQL_INTERNAL_PORT}
      - POSTGRESQL_DB=${LESSONS_POSTGRESQL_DB}
      - POSTGRESQL_USER=${LESSONS_POSTGRESQL_USERNAME}
      - POSTGRESQL_PASSWORD=${LESSONS_POSTGRESQL_PASSWORD}
      - DATABASE_URL=postgresql://${LESSONS_POSTGRESQL_USERNAME}:${LESSONS_POSTGRESQL_PASSWORD}@${POSTGRESQL_INTERNAL_HOST}:${POSTGRESQL_INTERNAL_PORT}/${LESSONS_POSTGRESQL_DB}
      - OAUTH_INTERNAL_PROTOCOL=${OAUTH_INTERNAL_PROTOCOL}
      - OAUTH_INTERNAL_HOST=${OAUTH_INTERNAL_HOST}
      - OAUTH_INTERNAL_API_PORT=${OAUTH_INTERNAL_API_PORT}
      - OTEL_SERVICE_NAME=lessons
      # Debug Configuration for Node.js
      - NODE_DEBUG_ENABLED=${NODE_DEBUG_ENABLED:-true}
      - NODE_DEBUG_SUSPEND=${NODE_DEBUG_SUSPEND:-false}
    ports:
      - ${LESSONS_EXTERNAL_API_PORT}:${LESSONS_INTERNAL_API_PORT}
      - ${LESSONS_EXTERNAL_DEBUG_PORT}:${LESSONS_INTERNAL_DEBUG_PORT}  # Porta de debug remoto para depuração passo-a-passo
    command: >
      sh -c "
      npx prisma migrate deploy &&
      if [ \"$$NODE_DEBUG_ENABLED\" = \"true\" ]; then
        if [ \"$$NODE_DEBUG_SUSPEND\" = \"true\" ]; then
          exec node --inspect-brk=0.0.0.0:${LESSONS_INTERNAL_DEBUG_PORT} dist/main.js
        else
          exec node --inspect=0.0.0.0:${LESSONS_INTERNAL_DEBUG_PORT} dist/main.js
        fi
      else
        exec node dist/main.js
      fi
      "
    networks:
      - constrsw
    depends_on:
      postgresql:
        condition: service_healthy
      oauth:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${LESSONS_INTERNAL_API_PORT}/api/v1/health || exit 1"]
      start_period: 40s
      interval: 10s
      timeout: 10s
      retries: 10

  # Professors API
  professors:
    container_name: professors
    build:
      context: ./backend/professors
      dockerfile: Dockerfile
    image: constrsw/professors
    environment:
      - POSTGRESQL_INTERNAL_HOST=${POSTGRESQL_INTERNAL_HOST}
      - POSTGRESQL_INTERNAL_PORT=${POSTGRESQL_INTERNAL_PORT}
      - PROFESSORS_POSTGRESQL_DB=${PROFESSORS_POSTGRESQL_DB}
      - POSTGRESQL_USERNAME=${PROFESSORS_POSTGRESQL_USERNAME}
      - POSTGRESQL_PASSWORD=${PROFESSORS_POSTGRESQL_PASSWORD}
      - OAUTH_INTERNAL_PROTOCOL=${OAUTH_INTERNAL_PROTOCOL}
      - OAUTH_INTERNAL_HOST=${OAUTH_INTERNAL_HOST}
      - OAUTH_INTERNAL_API_PORT=${OAUTH_INTERNAL_API_PORT}
      - OTEL_SERVICE_NAME=professors
      # Debug Configuration for Python
      - PYTHON_DEBUG_ENABLED=${PYTHON_DEBUG_ENABLED:-true}
      - PYTHON_DEBUG_WAIT=${PYTHON_DEBUG_WAIT:-false}
    ports:
      - ${PROFESSORS_EXTERNAL_API_PORT}:${PROFESSORS_INTERNAL_API_PORT}
      - ${PROFESSORS_EXTERNAL_DEBUG_PORT}:${PROFESSORS_INTERNAL_DEBUG_PORT}  # Porta de debug remoto para depuração passo-a-passo
    command: >
      sh -c "
      if [ \"$$PYTHON_DEBUG_ENABLED\" = \"true\" ]; then
        if [ \"$$PYTHON_DEBUG_WAIT\" = \"true\" ]; then
          python -m debugpy --listen 0.0.0.0:${PROFESSORS_INTERNAL_DEBUG_PORT} --wait-for-client -m uvicorn professors.main:app --host 0.0.0.0 --port 8082
        else
          python -m debugpy --listen 0.0.0.0:${PROFESSORS_INTERNAL_DEBUG_PORT} -m uvicorn professors.main:app --host 0.0.0.0 --port 8082
        fi
      else
        python -m uvicorn professors.main:app --host 0.0.0.0 --port 8082
      fi
      "
    networks:
      - constrsw
    depends_on:
      postgresql:
        condition: service_healthy
      oauth:
        condition: service_healthy 
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${PROFESSORS_INTERNAL_API_PORT}/api/v1/health || exit 1"]
      start_period: 40s
      interval: 10s
      timeout: 10s
      retries: 10

  # Reservations API
  reservations:
    container_name: reservations
    build:
      context: ./backend/reservations/
      dockerfile: Dockerfile
    image: constrsw/reservations
    environment:
      - POSTGRESQL_HOST=${POSTGRESQL_INTERNAL_HOST}
      - POSTGRESQL_PORT=${POSTGRESQL_INTERNAL_PORT}
      - POSTGRESQL_DB=${RESERVATIONS_POSTGRESQL_DB}
      - POSTGRESQL_USER=${RESERVATIONS_POSTGRESQL_USERNAME}
      - POSTGRESQL_PASSWORD=${RESERVATIONS_POSTGRESQL_PASSWORD}
      - OAUTH_INTERNAL_PROTOCOL=${OAUTH_INTERNAL_PROTOCOL}
      - OAUTH_INTERNAL_HOST=${OAUTH_INTERNAL_HOST}
      - OAUTH_INTERNAL_API_PORT=${OAUTH_INTERNAL_API_PORT}
      - OTEL_SERVICE_NAME=reservations
      # Debug Configuration for Node.js
      - NODE_DEBUG_ENABLED=${NODE_DEBUG_ENABLED:-true}
      - NODE_DEBUG_SUSPEND=${NODE_DEBUG_SUSPEND:-false}
    networks:
      - constrsw
    ports:
      - ${RESERVATIONS_EXTERNAL_API_PORT}:${RESERVATIONS_INTERNAL_API_PORT}
      - ${RESERVATIONS_EXTERNAL_DEBUG_PORT}:${RESERVATIONS_INTERNAL_DEBUG_PORT}  # Porta de debug remoto para depuração passo-a-passo
    depends_on:
      postgresql:
        condition: service_healthy
      oauth:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${RESERVATIONS_INTERNAL_API_PORT}/api/v1/health || exit 1"]
      start_period: 40s
      interval: 10s
      timeout: 10s
      retries: 10
    command: >
      sh -c "
      if [ \"$$NODE_DEBUG_ENABLED\" = \"true\" ]; then
        if [ \"$$NODE_DEBUG_SUSPEND\" = \"true\" ]; then
          exec node --inspect-brk=0.0.0.0:${RESERVATIONS_INTERNAL_DEBUG_PORT} dist/main.js
        else
          exec node --inspect=0.0.0.0:${RESERVATIONS_INTERNAL_DEBUG_PORT} dist/main.js
        fi
      else
        exec node dist/main.js
      fi
      "
      
  # Resources API
  resources:
    container_name: resources
    build:
      context: ./backend/resources/
      dockerfile: Dockerfile
    image: constrsw/resources
    environment:
      - MONGODB_INTERNAL_HOST=${MONGODB_INTERNAL_HOST}
      - MONGODB_INTERNAL_PORT=${MONGODB_INTERNAL_PORT}
      - RESOURCES_MONGODB_USER=${RESOURCES_MONGODB_USERNAME}
      - RESOURCES_MONGODB_PASSWORD=${RESOURCES_MONGODB_PASSWORD}
      - RESOURCES_MONGODB_DB=${RESOURCES_MONGODB_DB}
      - OAUTH_INTERNAL_PROTOCOL=${OAUTH_INTERNAL_PROTOCOL}
      - OAUTH_INTERNAL_HOST=${OAUTH_INTERNAL_HOST}
      - OAUTH_INTERNAL_API_PORT=${OAUTH_INTERNAL_API_PORT}
      - OTEL_SERVICE_NAME=resources
      # Debug Configuration for Node.js
      - NODE_DEBUG_ENABLED=${NODE_DEBUG_ENABLED:-true}
      - NODE_DEBUG_SUSPEND=${NODE_DEBUG_SUSPEND:-false}
    networks:
      - constrsw
    ports:
      - ${RESOURCES_EXTERNAL_API_PORT}:${RESOURCES_INTERNAL_API_PORT}
      - ${RESOURCES_EXTERNAL_DEBUG_PORT}:${RESOURCES_INTERNAL_DEBUG_PORT}  # Porta de debug remoto para depuração passo-a-passo
    depends_on:
      mongodb:
        condition: service_healthy
      oauth:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -f ${RESOURCES_INTERNAL_PROTOCOL}://${RESOURCES_INTERNAL_HOST}:${RESOURCES_INTERNAL_API_PORT}/api/v1/health || exit 1"]
      start_period: 40s
      interval: 10s
      timeout: 10s
      retries: 10
    command: >
      sh -c "
      if [ \"$$NODE_DEBUG_ENABLED\" = \"true\" ]; then
        if [ \"$$NODE_DEBUG_SUSPEND\" = \"true\" ]; then
          exec node --inspect-brk=0.0.0.0:${RESOURCES_INTERNAL_DEBUG_PORT} dist/main.js
        else
          exec node --inspect=0.0.0.0:${RESOURCES_INTERNAL_DEBUG_PORT} dist/main.js
        fi
      else
        exec node dist/main.js
      fi
      "

  # Rooms API
  rooms:
    container_name: rooms
    build:
      context: ./backend/rooms/
      dockerfile: Dockerfile
    image: constrsw/rooms
    environment:
      - POSTGRESQL_HOST=${POSTGRESQL_INTERNAL_HOST}
      - POSTGRESQL_PORT=${POSTGRESQL_INTERNAL_PORT}
      - POSTGRESQL_DB=${ROOMS_POSTGRESQL_DB}
      - POSTGRESQL_USER=${ROOMS_POSTGRESQL_USERNAME}
      - POSTGRESQL_PASSWORD=${ROOMS_POSTGRESQL_PASSWORD}
      - DATABASE_URL=postgresql://${ROOMS_POSTGRESQL_USERNAME}:${ROOMS_POSTGRESQL_PASSWORD}@${POSTGRESQL_INTERNAL_HOST}:${POSTGRESQL_INTERNAL_PORT}/${ROOMS_POSTGRESQL_DB}
      - OAUTH_INTERNAL_PROTOCOL=${OAUTH_INTERNAL_PROTOCOL}
      - OAUTH_INTERNAL_HOST=${OAUTH_INTERNAL_HOST}
      - OAUTH_INTERNAL_API_PORT=${OAUTH_INTERNAL_API_PORT}
      - OTEL_SERVICE_NAME=rooms
      # Debug Configuration for Node.js
      - NODE_DEBUG_ENABLED=${NODE_DEBUG_ENABLED:-true}
      - NODE_DEBUG_SUSPEND=${NODE_DEBUG_SUSPEND:-false}
    networks:
      - constrsw
    ports:
      - ${ROOMS_EXTERNAL_API_PORT}:${ROOMS_INTERNAL_API_PORT}
      - ${ROOMS_EXTERNAL_DEBUG_PORT}:${ROOMS_INTERNAL_DEBUG_PORT}  # Porta de debug remoto para depuração passo-a-passo
    depends_on:
      postgresql:
        condition: service_healthy
      oauth:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -f ${ROOMS_INTERNAL_PROTOCOL}://${ROOMS_INTERNAL_HOST}:${ROOMS_INTERNAL_API_PORT}/api/v1/health || exit 1"]
      start_period: 40s
      interval: 10s
      timeout: 10s
      retries: 10
    command: >
      sh -c "
      npx prisma db push &&
      if [ \"$$NODE_DEBUG_ENABLED\" = \"true\" ]; then
        if [ \"$$NODE_DEBUG_SUSPEND\" = \"true\" ]; then
          exec node --inspect-brk=0.0.0.0:${ROOMS_INTERNAL_DEBUG_PORT} dist/main.js
        else
          exec node --inspect=0.0.0.0:${ROOMS_INTERNAL_DEBUG_PORT} dist/main.js
        fi
      else
        exec npm run start:prod
      fi
      "

  # Students API
  students:
    container_name: students
    build:
      context: ./backend/students/
      dockerfile: Dockerfile
    image: constrsw/students
    environment:
      - POSTGRESQL_HOST=${POSTGRESQL_INTERNAL_HOST}
      - POSTGRESQL_PORT=${POSTGRESQL_INTERNAL_PORT}
      - POSTGRESQL_DB=${STUDENTS_POSTGRESQL_DB}
      - POSTGRESQL_USER=${STUDENTS_POSTGRESQL_USERNAME}
      - POSTGRESQL_PASSWORD=${STUDENTS_POSTGRESQL_PASSWORD}
      - OAUTH_INTERNAL_PROTOCOL=${OAUTH_INTERNAL_PROTOCOL}
      - OAUTH_INTERNAL_HOST=${OAUTH_INTERNAL_HOST}
      - OAUTH_INTERNAL_API_PORT=${OAUTH_INTERNAL_API_PORT}
      - ASPNETCORE_URLS=http://+:${STUDENTS_INTERNAL_API_PORT}
      - ConnectionStrings__DefaultConnection=Host=postgresql;Database=students_db;Username=${POSTGRESQL_USERNAME};Password=${POSTGRESQL_PASSWORD}
      - ENABLE_SWAGGER=${ENABLE_SWAGGER}
      - OTEL_SERVICE_NAME=students
      # Debug Configuration for .NET
      - DOTNET_DBG_ENABLE=${DOTNET_DBG_ENABLE:-1}
      - DOTNET_DBG_PORT=${STUDENTS_INTERNAL_DEBUG_PORT}
    networks:
      - constrsw
    ports:
      - ${STUDENTS_EXTERNAL_API_PORT}:${STUDENTS_INTERNAL_API_PORT}
      - ${STUDENTS_EXTERNAL_DEBUG_PORT}:${STUDENTS_INTERNAL_DEBUG_PORT}  # Porta de debug remoto para depuração passo-a-passo
    depends_on:
      postgresql:
        condition: service_healthy
      oauth:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -f ${STUDENTS_INTERNAL_PROTOCOL}://${STUDENTS_INTERNAL_HOST}:${STUDENTS_INTERNAL_API_PORT}/api/v1/health || exit 1"]
      start_period: 40s
      interval: 10s
      timeout: 10s
      retries: 10
    command: >
      sh -c "
      if [ \"$$DOTNET_DBG_ENABLE\" = \"1\" ]; then
        export DOTNET_DBG_ENABLE=1
        export DOTNET_DBG_PORT=$${STUDENTS_INTERNAL_DEBUG_PORT}
        dotnet Students.Api.dll
      else
        dotnet Students.Api.dll
      fi
      "

  # BFF API
  bff:
    container_name: bff
    build:
      context: ./backend/bff/
      dockerfile: Dockerfile
    image: constrsw/bff
    environment:
      - NODE_ENV=production
      - PORT=${BFF_INTERNAL_API_PORT}
      - CORS_ORIGIN=${CORS_ORIGIN}
      - ENABLE_SWAGGER=${ENABLE_SWAGGER}
      # OAuth/OIDC
      - OAUTH_ISSUER=${KEYCLOAK_SERVER_URL}/realms/${KEYCLOAK_REALM}
      - OAUTH_CLIENT_ID=${KEYCLOAK_CLIENT_ID}
      - OAUTH_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET}
      - OAUTH_TOKEN_ENDPOINT=/api/v1/login
      - OAUTH_JWKS_URI=/.well-known/jwks.json
      - OAUTH_AUDIENCE=${KEYCLOAK_CLIENT_ID}
      # JWT
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-1h}
      # Microservices - OAuth
      - OAUTH_INTERNAL_HOST=${OAUTH_INTERNAL_HOST}
      - OAUTH_INTERNAL_API_PORT=${OAUTH_INTERNAL_API_PORT}
      - OAUTH_TIMEOUT=5000
      # Microservices - Employees
      - EMPLOYEES_INTERNAL_HOST=${EMPLOYEES_INTERNAL_HOST}
      - EMPLOYEES_INTERNAL_API_PORT=${EMPLOYEES_INTERNAL_API_PORT}
      - EMPLOYEES_TIMEOUT=5000
      # Microservices - Students
      - STUDENTS_INTERNAL_HOST=${STUDENTS_INTERNAL_HOST}
      - STUDENTS_INTERNAL_API_PORT=${STUDENTS_INTERNAL_API_PORT}
      - STUDENTS_TIMEOUT=5000
      # Microservices - Professors
      - PROFESSORS_INTERNAL_HOST=${PROFESSORS_INTERNAL_HOST}
      - PROFESSORS_INTERNAL_API_PORT=${PROFESSORS_INTERNAL_API_PORT}
      - PROFESSORS_TIMEOUT=5000
      # Microservices - Courses
      - COURSES_INTERNAL_HOST=${COURSES_INTERNAL_HOST}
      - COURSES_INTERNAL_API_PORT=${COURSES_INTERNAL_API_PORT}
      - COURSES_TIMEOUT=5000
      # Microservices - Classes
      - CLASSES_INTERNAL_HOST=${CLASSES_INTERNAL_HOST}
      - CLASSES_INTERNAL_API_PORT=${CLASSES_INTERNAL_API_PORT}
      - CLASSES_TIMEOUT=5000
      # Microservices - Lessons
      - LESSONS_INTERNAL_HOST=${LESSONS_INTERNAL_HOST}
      - LESSONS_INTERNAL_API_PORT=${LESSONS_INTERNAL_API_PORT}
      - LESSONS_TIMEOUT=5000
      # Microservices - Reservations
      - RESERVATIONS_INTERNAL_HOST=${RESERVATIONS_INTERNAL_HOST}
      - RESERVATIONS_INTERNAL_API_PORT=${RESERVATIONS_INTERNAL_API_PORT}
      - RESERVATIONS_TIMEOUT=5000
      # Microservices - Resources
      - RESOURCES_INTERNAL_HOST=${RESOURCES_INTERNAL_HOST}
      - RESOURCES_INTERNAL_API_PORT=${RESOURCES_INTERNAL_API_PORT}
      - RESOURCES_TIMEOUT=5000
      # Microservices - Rooms
      - ROOMS_INTERNAL_HOST=${ROOMS_INTERNAL_HOST}
      - ROOMS_INTERNAL_API_PORT=${ROOMS_INTERNAL_API_PORT}
      - ROOMS_TIMEOUT=5000
      # Cache
      - CACHE_TTL=300
      - CACHE_MAX=100
      # Rate Limiting
      - THROTTLE_TTL=60
      - THROTTLE_LIMIT=100
      # HTTP
      - HTTP_TIMEOUT=5000
      # Circuit Breaker
      - CIRCUIT_BREAKER_TIMEOUT=3000
      - CIRCUIT_BREAKER_ERROR_THRESHOLD=50
      - CIRCUIT_BREAKER_RESET_TIMEOUT=30000
      # Request Timeout
      - REQUEST_TIMEOUT=10000
      # OpenTelemetry
      - OTEL_SERVICE_NAME=bff
      - OTEL_SERVICE_VERSION=1.0.0
      - METRICS_PORT=9464
      # Debug Configuration for Node.js
      - NODE_DEBUG_ENABLED=${NODE_DEBUG_ENABLED:-true}
      - NODE_DEBUG_SUSPEND=${NODE_DEBUG_SUSPEND:-false}
    networks:
      - constrsw
    ports:
      - ${BFF_EXTERNAL_API_PORT}:${BFF_INTERNAL_API_PORT}
      - ${BFF_EXTERNAL_DEBUG_PORT}:${BFF_INTERNAL_DEBUG_PORT}  # Porta de debug remoto para depuração passo-a-passo
    depends_on:
      oauth:
        condition: service_healthy
      employees:
        condition: service_healthy
      students:
        condition: service_healthy
      professors:
        condition: service_healthy
      courses:
        condition: service_healthy
      classes:
        condition: service_healthy
      lessons:
        condition: service_healthy
      reservations:
        condition: service_healthy
      resources:
        condition: service_healthy
      rooms:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3000/api/v1/health > /dev/null || exit 1"]
      start_period: 50s
      interval: 10s
      timeout: 10s
      retries: 10
    command: >
      sh -c "
      if [ \"$$NODE_DEBUG_ENABLED\" = \"true\" ]; then
        if [ \"$$NODE_DEBUG_SUSPEND\" = \"true\" ]; then
          exec node --inspect-brk=0.0.0.0:${BFF_INTERNAL_DEBUG_PORT} dist/main
        else
          exec node --inspect=0.0.0.0:${BFF_INTERNAL_DEBUG_PORT} dist/main
        fi
      else
        exec node dist/main
      fi
      "

  # Frontend React
  frontend:
    container_name: frontend
    build:
      context: ./frontend/
      dockerfile: Dockerfile
    image: constrsw/frontend
    environment:
      - VITE_API_URL=${VITE_API_URL}
      - VITE_KEYCLOAK_URL=${VITE_KEYCLOAK_URL}
      - VITE_KEYCLOAK_REALM=${VITE_KEYCLOAK_REALM}
      - VITE_KEYCLOAK_CLIENT_ID=${VITE_KEYCLOAK_CLIENT_ID}
      - BFF_INTERNAL_HOST=${BFF_INTERNAL_HOST}
      - BFF_INTERNAL_API_PORT=${BFF_INTERNAL_API_PORT}
    networks:
      - constrsw
    ports:
      - ${FRONTEND_EXTERNAL_PORT}:${FRONTEND_INTERNAL_PORT}
    depends_on:
      bff:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80 || exit 1"]
      start_period: 60s
      interval: 10s
      timeout: 10s
      retries: 10
