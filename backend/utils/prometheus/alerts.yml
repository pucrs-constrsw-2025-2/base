groups:
  - name: constrsw_alerts
    rules:
      # Alerta quando um serviço está down
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Serviço {{ $labels.job }} está offline"
          description: "O serviço {{ $labels.job }} está offline há mais de 1 minuto"

      # Alerta para tempo de resposta alto
      - alert: HighResponseTime
        expr: http_server_requests_seconds_max > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Tempo de resposta alto para {{ $labels.job }}"
          description: "O tempo de resposta do serviço {{ $labels.job }} está acima de 2 segundos"

      # Alerta para uso de memória alto
      - alert: HighMemoryUsage
        expr: (jvm_memory_used_bytes / jvm_memory_max_bytes) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Uso de memória alto para {{ $labels.job }}"
          description: "O uso de memória do serviço {{ $labels.job }} está acima de 80%"

      # Alerta para uso de CPU alto
      - alert: HighCPUUsage
        expr: process_cpu_usage > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Uso de CPU alto para {{ $labels.job }}"
          description: "O uso de CPU do serviço {{ $labels.job }} está acima de 80%"

      # Alerta para muitas conexões de banco de dados
      - alert: HighDatabaseConnections
        expr: hikaricp_connections_active / hikaricp_connections_max > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Muitas conexões de banco para {{ $labels.job }}"
          description: "O serviço {{ $labels.job }} está usando mais de 80% das conexões disponíveis"

      # Alerta para erro rate alto
      - alert: HighErrorRate
        expr: rate(http_server_requests_seconds_count{status=~"5.."}[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Taxa de erro alta para {{ $labels.job }}"
          description: "O serviço {{ $labels.job }} está retornando muitos erros 5xx"

      # Alerta para garbage collection frequente
      - alert: FrequentGarbageCollection
        expr: rate(jvm_gc_collection_seconds_count[5m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Garbage collection frequente para {{ $labels.job }}"
          description: "O serviço {{ $labels.job }} está fazendo garbage collection muito frequentemente"

      # Alerta para tempo de garbage collection alto
      - alert: LongGarbageCollection
        expr: jvm_gc_collection_seconds_sum > 1
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Garbage collection longo para {{ $labels.job }}"
          description: "O garbage collection do serviço {{ $labels.job }} está demorando mais de 1 segundo"

      # Alerta para serviços específicos do domínio
      - alert: ClassesServiceDown
        expr: up{job="classes"} == 0
        for: 1m
        labels:
          severity: critical
          service: classes
        annotations:
          summary: "Serviço de Classes está offline"
          description: "O serviço de gerenciamento de classes está offline"

      - alert: CoursesServiceDown
        expr: up{job="courses"} == 0
        for: 1m
        labels:
          severity: critical
          service: courses
        annotations:
          summary: "Serviço de Courses está offline"
          description: "O serviço de gerenciamento de cursos está offline"

      - alert: LessonsServiceDown
        expr: up{job="lessons"} == 0
        for: 1m
        labels:
          severity: critical
          service: lessons
        annotations:
          summary: "Serviço de Lessons está offline"
          description: "O serviço de gerenciamento de aulas está offline"

      - alert: ProfessorsServiceDown
        expr: up{job="professors"} == 0
        for: 1m
        labels:
          severity: critical
          service: professors
        annotations:
          summary: "Serviço de Professors está offline"
          description: "O serviço de gerenciamento de professores está offline"

      - alert: ReservationsServiceDown
        expr: up{job="reservations"} == 0
        for: 1m
        labels:
          severity: critical
          service: reservations
        annotations:
          summary: "Serviço de Reservations está offline"
          description: "O serviço de gerenciamento de reservas está offline"

      - alert: ResourcesServiceDown
        expr: up{job="resources"} == 0
        for: 1m
        labels:
          severity: critical
          service: resources
        annotations:
          summary: "Serviço de Resources está offline"
          description: "O serviço de gerenciamento de recursos está offline"

      - alert: RoomsServiceDown
        expr: up{job="rooms"} == 0
        for: 1m
        labels:
          severity: critical
          service: rooms
        annotations:
          summary: "Serviço de Rooms está offline"
          description: "O serviço de gerenciamento de salas está offline"

      - alert: StudentsServiceDown
        expr: up{job="students"} == 0
        for: 1m
        labels:
          severity: critical
          service: students
        annotations:
          summary: "Serviço de Students está offline"
          description: "O serviço de gerenciamento de estudantes está offline"

      - alert: OAuthServiceDown
        expr: up{job="oauth"} == 0
        for: 1m
        labels:
          severity: critical
          service: oauth
        annotations:
          summary: "Serviço de OAuth está offline"
          description: "O serviço de autenticação está offline"

      - alert: BFFServiceDown
        expr: up{job="bff"} == 0
        for: 1m
        labels:
          severity: critical
          service: bff
        annotations:
          summary: "Serviço BFF está offline"
          description: "O Backend for Frontend está offline"

      # Alertas de Health Check via Blackbox Exporter
      - alert: HealthCheckFailed
        expr: probe_success{job="health-checks"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Health check falhou para {{ $labels.instance }}"
          description: "O endpoint de health check {{ $labels.instance }} está retornando erro há mais de 1 minuto"

      - alert: HealthCheckSlow
        expr: probe_http_duration_seconds{job="health-checks"} > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Health check lento para {{ $labels.instance }}"
          description: "O endpoint de health check {{ $labels.instance }} está demorando mais de 2 segundos para responder"

      - alert: OAuthHealthCheckFailed
        expr: probe_success{job="health-checks",instance=~".*oauth.*"} == 0
        for: 1m
        labels:
          severity: critical
          service: oauth
        annotations:
          summary: "Health check do OAuth falhou"
          description: "O endpoint de health check do serviço OAuth está retornando erro"

      - alert: CoursesHealthCheckFailed
        expr: probe_success{job="health-checks",instance=~".*courses.*"} == 0
        for: 1m
        labels:
          severity: critical
          service: courses
        annotations:
          summary: "Health check do Courses falhou"
          description: "O endpoint de health check do serviço Courses está retornando erro"

      - alert: ProfessorsHealthCheckFailed
        expr: probe_success{job="health-checks",instance=~".*professors.*"} == 0
        for: 1m
        labels:
          severity: critical
          service: professors
        annotations:
          summary: "Health check do Professors falhou"
          description: "O endpoint de health check do serviço Professors está retornando erro"

      - alert: LessonsHealthCheckFailed
        expr: probe_success{job="health-checks",instance=~".*lessons.*"} == 0
        for: 1m
        labels:
          severity: critical
          service: lessons
        annotations:
          summary: "Health check do Lessons falhou"
          description: "O endpoint de health check do serviço Lessons está retornando erro"

      - alert: ReservationsHealthCheckFailed
        expr: probe_success{job="health-checks",instance=~".*reservations.*"} == 0
        for: 1m
        labels:
          severity: critical
          service: reservations
        annotations:
          summary: "Health check do Reservations falhou"
          description: "O endpoint de health check do serviço Reservations está retornando erro"

      - alert: ResourcesHealthCheckFailed
        expr: probe_success{job="health-checks",instance=~".*resources.*"} == 0
        for: 1m
        labels:
          severity: critical
          service: resources
        annotations:
          summary: "Health check do Resources falhou"
          description: "O endpoint de health check do serviço Resources está retornando erro"

      - alert: RoomsHealthCheckFailed
        expr: probe_success{job="health-checks",instance=~".*rooms.*"} == 0
        for: 1m
        labels:
          severity: critical
          service: rooms
        annotations:
          summary: "Health check do Rooms falhou"
          description: "O endpoint de health check do serviço Rooms está retornando erro"

      - alert: StudentsHealthCheckFailed
        expr: probe_success{job="health-checks",instance=~".*students.*"} == 0
        for: 1m
        labels:
          severity: critical
          service: students
        annotations:
          summary: "Health check do Students falhou"
          description: "O endpoint de health check do serviço Students está retornando erro"

      - alert: EmployeesHealthCheckFailed
        expr: probe_success{job="health-checks",instance=~".*employees.*"} == 0
        for: 1m
        labels:
          severity: critical
          service: employees
        annotations:
          summary: "Health check do Employees falhou"
          description: "O endpoint de health check do serviço Employees está retornando erro"

      - alert: ClassesHealthCheckFailed
        expr: probe_success{job="health-checks",instance=~".*classes.*"} == 0
        for: 1m
        labels:
          severity: critical
          service: classes
        annotations:
          summary: "Health check do Classes falhou"
          description: "O endpoint de health check do serviço Classes está retornando erro"