openapi: 3.1.0
info:
  title: ConstrSW - OAuth API Gateway
  description: API Gateway para o Keycloak, implementando os requisitos do T1.
  version: 1.0.0
servers:
  - url: http://localhost:8180
    description: Servidor de desenvolvimento (externo)
  - url: http://oauth:8000
    description: Servidor interno (Docker)

tags:
  - name: Authentication
    description: Endpoints de autenticação e gerenciamento de tokens
  - name: Users
    description: Gerenciamento de usuários
  - name: Roles
    description: Gerenciamento de roles (permissões)

paths:
  /api/v1/login:
    post:
      tags:
        - Authentication
      summary: Autenticação de Usuário
      description: Autentica o usuário com username e password, usando o 'password' grant type do Keycloak. Retorna access_token e refresh_token.
      operationId: login
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  format: email
                  example: joao.silva@email.com
                password:
                  type: string
                  format: password
                  example: strongPassword123
      responses:
        '201':
          description: Autenticação bem-sucedida
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Credenciais inválidas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/refresh:
    post:
      tags:
        - Authentication
      summary: Renovação de Access Token
      description: Obtém um novo access_token e refresh_token usando um refresh_token válido.
      operationId: refreshToken
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
                  example: eyJhbGciOiJIUzI1NiIsIn...
      responses:
        '201':
          description: Token renovado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '400':
          description: Refresh token inválido ou expirado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/validate:
    post:
      tags:
        - Authentication
      summary: Validação de Access Token
      description: Valida um access_token, verificando sua autenticidade e se não está expirado junto ao provedor de identidade (Keycloak).
      operationId: validateToken
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Token válido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IntrospectResponse'
        '401':
          description: Token inválido ou expirado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/users:
    post:
      tags:
        - Users
      summary: Criar um novo usuário
      description: Cria um novo usuário no sistema. Este endpoint pode ser público ou protegido dependendo da configuração global.
      operationId: createUser
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserCreateRequest'
      responses:
        '201':
          description: Usuário criado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '400':
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Não autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    get:
      tags:
        - Users
      summary: Listar todos os usuários
      description: Retorna uma lista de todos os usuários cadastrados, com a opção de filtrar por status (enabled). Requer autenticação.
      operationId: getAllUsers
      security:
        - bearerAuth: []
      parameters:
        - name: enabled
          in: query
          description: Filtrar por status (true/false)
          required: false
          schema:
            type: boolean
      responses:
        '200':
          description: Lista de usuários
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserResponse'
        '401':
          description: Não autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/users/{userId}:
    get:
      tags:
        - Users
      summary: Buscar um usuário por ID
      description: Retorna os detalhes de um usuário específico a partir do seu ID. Requer autenticação.
      operationId: getUserById
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID único do usuário
      responses:
        '200':
          description: Dados do usuário
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          description: Não autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Usuário não encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - Users
      summary: Atualizar um usuário (completo)
      description: Atualiza as informações de um usuário existente. Todos os campos devem ser fornecidos. Requer autenticação.
      operationId: updateUser
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID único do usuário
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdateRequest'
      responses:
        '200':
          description: Usuário atualizado com sucesso
        '400':
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Não autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Usuário não encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    patch:
      tags:
        - Users
      summary: Atualizar a senha de um usuário
      description: Define uma nova senha para um usuário específico. O corpo da requisição deve conter a nova senha. Requer autenticação.
      operationId: resetPassword
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID único do usuário
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PasswordUpdateRequest'
      responses:
        '204':
          description: Senha atualizada com sucesso
        '400':
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Não autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Usuário não encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags:
        - Users
      summary: Desativar um usuário
      description: Realiza a exclusão lógica (desativação) de um usuário, alterando seu status para 'disabled'. Requer autenticação.
      operationId: deleteUser
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID único do usuário
      responses:
        '204':
          description: Usuário desativado com sucesso
        '401':
          description: Não autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Usuário não encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/users/{user_id}/roles:
    get:
      tags:
        - Users
      summary: Listar roles de um usuário
      description: Retorna uma lista com todos os roles associados a um usuário específico.
      operationId: getUserRoles
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID único do usuário
      responses:
        '200':
          description: Lista de roles do usuário
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/RoleResponse'
        '401':
          description: Não autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Usuário não encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      tags:
        - Users
      summary: Atribuir roles a um usuário
      description: Atribui uma ou mais roles a um usuário específico, com base nos IDs das roles fornecidos. Requer autenticação.
      operationId: assignRolesToUser
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID único do usuário
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserRolesRequest'
      responses:
        '204':
          description: Roles atribuídos com sucesso
        '400':
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Não autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Usuário ou role não encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags:
        - Users
      summary: Remover roles de um usuário
      description: Remove uma ou mais roles de um usuário específico, com base nos IDs das roles fornecidos. Requer autenticação.
      operationId: removeRolesFromUser
      security:
        - bearerAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID único do usuário
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserRolesRequest'
      responses:
        '204':
          description: Roles removidos com sucesso
        '400':
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Não autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Usuário ou role não encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/roles:
    post:
      tags:
        - Roles
      summary: Criar um novo role
      description: Cria um novo role no sistema com um nome e uma descrição.
      operationId: createRole
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleCreateRequest'
      responses:
        '201':
          description: Role criado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoleResponse'
        '400':
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Não autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    get:
      tags:
        - Roles
      summary: Listar todos os roles
      description: Retorna uma lista com todos os roles cadastrados, com a opção de filtrar por status (enabled).
      operationId: getAllRoles
      security:
        - bearerAuth: []
      parameters:
        - name: enabled
          in: query
          description: Filtrar por status (true/false)
          required: false
          schema:
            type: boolean
      responses:
        '200':
          description: Lista de roles
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/RoleResponse'
        '401':
          description: Não autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/roles/{roleId}:
    get:
      tags:
        - Roles
      summary: Buscar um role por ID
      description: Recupera os dados de um role específico a partir do seu ID único.
      operationId: getRoleById
      security:
        - bearerAuth: []
      parameters:
        - name: roleId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID único do role
      responses:
        '200':
          description: Dados do role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoleResponse'
        '401':
          description: Não autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Role não encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - Roles
      summary: Atualizar um role (completo)
      description: Atualiza todos os dados de um role específico. Todos os campos devem ser fornecidos.
      operationId: updateRole
      security:
        - bearerAuth: []
      parameters:
        - name: roleId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID único do role
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoleUpdateRequest'
      responses:
        '200':
          description: Role atualizado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoleResponse'
        '400':
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Não autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Role não encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    patch:
      tags:
        - Roles
      summary: Atualizar um role (parcial)
      description: Atualiza parcialmente os dados de um role específico. Apenas os campos fornecidos no corpo da requisição serão alterados.
      operationId: partialUpdateRole
      security:
        - bearerAuth: []
      parameters:
        - name: roleId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID único do role
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RolePartialUpdateRequest'
      responses:
        '200':
          description: Role atualizado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoleResponse'
        '400':
          description: Dados inválidos
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Não autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Role não encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags:
        - Roles
      summary: Excluir um role
      description: Exclui um role do sistema de forma permanente a partir do seu ID. Esta operação não pode ser desfeita.
      operationId: deleteRole
      security:
        - bearerAuth: []
      parameters:
        - name: roleId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: ID único do role
      responses:
        '204':
          description: Role excluído com sucesso
        '401':
          description: Não autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Role não encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/health:
    get:
      tags:
        - Health
      summary: Health check
      description: Verifica o status de saúde da API
      operationId: healthCheck
      responses:
        '200':
          description: Serviço está funcionando
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: UP
                  components:
                    type: object
                    properties:
                      service:
                        type: object
                        properties:
                          status:
                            type: string
                            example: UP
                          details:
                            type: object
                            properties:
                              name:
                                type: string
                                example: oauth
                              version:
                                type: string
                                example: 1.0.0

  /api/v1/metrics:
    get:
      tags:
        - Metrics
      summary: Métricas Prometheus
      description: Retorna métricas no formato Prometheus
      operationId: getMetrics
      responses:
        '200':
          description: Métricas em formato Prometheus
          content:
            text/plain:
              schema:
                type: string

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Token JWT obtido através do endpoint /api/v1/login

  schemas:
    TokenResponse:
      type: object
      properties:
        access_token:
          type: string
          description: Token de acesso JWT
          example: eyJhbGciOiJSUzI1NiIsIn...
        expires_in:
          type: integer
          description: Tempo de expiração do access token em segundos
          example: 300
        refresh_expires_in:
          type: integer
          description: Tempo de expiração do refresh token em segundos
          example: 1800
        refresh_token:
          type: string
          description: Token de renovação
          example: eyJhbGciOiJIUzI1NiIsIn...
        token_type:
          type: string
          description: Tipo do token
          example: Bearer

    IntrospectResponse:
      type: object
      properties:
        active:
          type: boolean
          description: Indica se o token está ativo
          example: true
        username:
          type: string
          nullable: true
          description: Nome de usuário associado ao token
          example: joao.silva@email.com
        scope:
          type: string
          nullable: true
          description: Escopos do token
        client_id:
          type: string
          nullable: true
          description: ID do cliente
        exp:
          type: integer
          nullable: true
          description: Timestamp de expiração
        iat:
          type: integer
          nullable: true
          description: Timestamp de emissão

    UserCreateRequest:
      type: object
      required:
        - username
        - password
        - firstName
        - lastName
      properties:
        username:
          type: string
          format: email
          description: Email do usuário (usado como username)
          example: joao.silva@email.com
        password:
          type: string
          format: password
          minLength: 8
          description: Senha do usuário
          example: strongPassword123
        firstName:
          type: string
          description: Primeiro nome do usuário
          example: João
        lastName:
          type: string
          description: Sobrenome do usuário
          example: Silva

    UserUpdateRequest:
      type: object
      properties:
        username:
          type: string
          format: email
          description: Email do usuário (usado como username)
          example: jose.santos@email.com
        firstName:
          type: string
          description: Primeiro nome do usuário
          example: José
        lastName:
          type: string
          description: Sobrenome do usuário
          example: Santos
        enabled:
          type: boolean
          description: Status do usuário (ativo/inativo)
          example: true

    PasswordUpdateRequest:
      type: object
      required:
        - password
      properties:
        password:
          type: string
          format: password
          minLength: 8
          description: Nova senha do usuário
          example: newStrongPassword123

    UserResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: ID único do usuário
          example: a0b3827f-4912-4cfc-a2b8-a6d15e2a865b
        username:
          type: string
          format: email
          description: Email do usuário
          example: joao.silva@email.com
        firstName:
          type: string
          description: Primeiro nome do usuário
          example: João
        lastName:
          type: string
          description: Sobrenome do usuário
          example: Silva
        enabled:
          type: boolean
          description: Status do usuário (ativo/inativo)
          example: true

    UserRolesRequest:
      type: object
      required:
        - role_ids
      properties:
        role_ids:
          type: array
          items:
            type: string
            format: uuid
          description: Lista de IDs de roles a serem gerenciados
          example:
            - a0b3827f-4912-4cfc-a2b8-a6d15e2a865b
            - b1c4938g-5023-5dfd-b3c9-b7e26f3b976c

    RoleCreateRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 3
          maxLength: 50
          description: Nome do role
          example: admin
        description:
          type: string
          maxLength: 255
          description: Descrição do role
          example: Administrador do sistema
        enabled:
          type: boolean
          description: Define o role como ativo ou inativo
          default: true
          example: true

    RoleUpdateRequest:
      type: object
      required:
        - name
        - enabled
      properties:
        name:
          type: string
          minLength: 3
          maxLength: 50
          description: Nome do role
          example: gerente
        description:
          type: string
          maxLength: 255
          description: Descrição do role
          example: Gerente de projetos
        enabled:
          type: boolean
          description: Define o role como ativo ou inativo
          example: true

    RolePartialUpdateRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 3
          maxLength: 50
          description: Novo nome do role
          example: desenvolvedor
        description:
          type: string
          maxLength: 255
          description: Nova descrição do role
          example: Desenvolvedor de software sênior
        enabled:
          type: boolean
          description: Muda o estado do role para ativo ou inativo
          example: false

    RoleResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: ID único do role
          example: a0b3827f-4912-4cfc-a2b8-a6d15e2a865b
        name:
          type: string
          description: Nome do role
          example: admin
        description:
          type: string
          nullable: true
          description: Descrição do role
          example: Administrador do sistema
        enabled:
          type: boolean
          description: Indica se o role está ativo
          example: true

    Error:
      type: object
      properties:
        detail:
          type: string
          description: Mensagem de erro
          example: Credenciais inválidas. Verifique o usuário e a senha.

