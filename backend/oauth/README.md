# üõ°Ô∏è OAuth API Gateway para Keycloak

Este projeto √© uma API Gateway robusta e de alta performance, constru√≠da em Python com FastAPI, que atua como uma camada de desacoplamento para a API REST do Keycloak. O objetivo principal √© fornecer uma interface moderna, segura e f√°cil de usar para gerenciar usu√°rios e roles, seguindo os princ√≠pios da Arquitetura Hexagonal (Ports & Adapters).

---

## üöÄ Arquitetura e Padr√µes de Projeto

A arquitetura do projeto √© estritamente baseada no padr√£o **Ports & Adapters (Arquitetura Hexagonal)**. Essa abordagem garante um forte desacoplamento entre a l√≥gica de neg√≥cio principal (o _core_ da aplica√ß√£o) e as tecnologias externas, como o framework web e o cliente HTTP para o Keycloak.

- **Core (O Hex√°gono) „Ç≥„Ç¢**: Cont√©m a l√≥gica de neg√≥cio pura, sem depend√™ncias de frameworks. Inclui os `domain models`, `ports` (interfaces) e `services`.
- **Adapters (As Portas) „Ç¢„ÉÄ„Éó„Çø„Éº**: S√£o as implementa√ß√µes concretas que interagem com o mundo exterior.
  - **Driving Adapter**: A API FastAPI, que "dirige" a aplica√ß√£o (`adapters/api`).
  - **Driven Adapter**: O cliente para o Keycloak, que √© "dirigido" pela aplica√ß√£o (`adapters/keycloak`).

## üõ†Ô∏è Tecnologias e Ferramentas

A sele√ß√£o de tecnologias priorizou performance, seguran√ßa e um ecossistema moderno para o desenvolvimento de APIs.

| Categoria                  | Ferramenta                                                                                                                                 |
| -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
| **Linguagem & Framework**  | üêç `Python 3.12` <br> ‚ö° `FastAPI`                                                                                                         |
| **Servidor ASGI**          | ü¶Ñ `Uvicorn` com `Gunicorn`                                                                                                                |
| **Gerenciador de Pacotes** | üì¶ `Poetry`                                                                                                                                |
| **Qualidade de C√≥digo**    | Î¶∞ÌÑ∞ `Ruff` (Linter) <br> üé® `Black` (Formatador) <br> üîí `MyPy` (An√°lise de Tipos)                                                        |
| **Testes**                 | üß™ `Pytest` & `Pytest-Cov`                                                                                                                 |
| **Cliente HTTP**           | üåê `HTTPX` (com suporte a async/await)                                                                                                     |
| **Valida√ß√£o & Config.**    | ‚úÖ `Pydantic V2` <br> ‚öôÔ∏è `Pydantic-Settings`                                                                                               |
| **Seguran√ßa (AppSec)**     | üîë `python-jose` (Valida√ß√£o de JWT) <br> ü§´ `passlib` (Hashing de senhas) <br> üêû `Bandit` (SAST) <br> üê≥ `Trivy` (Scan de Imagens Docker) |

## üìÅ Estrutura de Diret√≥rios

A estrutura do projeto reflete a arquitetura hexagonal, separando claramente as responsabilidades.

    /oauth/
    ‚îú‚îÄ‚îÄ .github/
    ‚îÇ   ‚îî‚îÄ‚îÄ workflows/
    ‚îÇ       ‚îî‚îÄ‚îÄ ci.yml                # üöÄ Pipeline de CI/CD (lint, test, scan)
    ‚îú‚îÄ‚îÄ oauth_api/
    ‚îÇ   ‚îú‚îÄ‚îÄ main.py                   # üèÅ Entrypoint da aplica√ß√£o FastAPI
    ‚îÇ   ‚îú‚îÄ‚îÄ config.py                 # ‚öôÔ∏è Configura√ß√£o com Pydantic-Settings
    ‚îÇ   ‚îú‚îÄ‚îÄ core/                     # Ìó•ÏÇ¨Í≥§ L√≥gica de Neg√≥cio (O Hex√°gono)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ domain/               # üì¶ Modelos de dom√≠nio (User, Role)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ports/                # üîå Interfaces (ex: IUserRepository)
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ services/             # üíº Orquestra√ß√£o da l√≥gica de neg√≥cio
    ‚îÇ   ‚îî‚îÄ‚îÄ adapters/                 # üö™ Implementa√ß√µes (As Portas)
    ‚îÇ       ‚îú‚îÄ‚îÄ api/                  # üåê Driving Adapter (FastAPI)
    ‚îÇ       ‚îî‚îÄ‚îÄ keycloak/             # üîë Driven Adapter (Cliente Keycloak)
    ‚îú‚îÄ‚îÄ tests/                        # üß™ Testes Unit√°rios e de Integra√ß√£o
    ‚îú‚îÄ‚îÄ pyproject.toml                # üì¶ Defini√ß√£o do projeto e depend√™ncias (Poetry)
    ‚îú‚îÄ‚îÄ Dockerfile                    # üê≥ Dockerfile da aplica√ß√£o
    ‚îî‚îÄ‚îÄ README.md                     # üìñ Voc√™ est√° aqui!

## üìú Documenta√ß√£o da API (Swagger)

A documenta√ß√£o interativa da API √© gerada automaticamente pelo FastAPI e est√° dispon√≠vel para testes e consulta dos endpoints.

- **URL da Documenta√ß√£o Swagger UI:** `/docs`

> Exemplo: `http://localhost:8000/docs`

## API Endpoints

### Autentica√ß√£o

| M√©todo | Endpoint | Descri√ß√£o                                  |
| :----- | :------- | :----------------------------------------- |
| `POST` | `/login` | Realiza a autentica√ß√£o e retorna um token. |

### Usu√°rios (`/users`)

| M√©todo   | Endpoint      | Descri√ß√£o                                                                  |
| :------- | :------------ | :------------------------------------------------------------------------- | -------- |
| `POST`   | `/users`      | Cria um novo usu√°rio. Responde com `409 Conflict` se o usu√°rio j√° existir. |
| `GET`    | `/users`      | Lista todos os usu√°rios. Suporta filtro por status com `?enabled=[true     | false]`. |
| `GET`    | `/users/{id}` | Obt√©m os detalhes de um usu√°rio espec√≠fico.                                |
| `PUT`    | `/users/{id}` | Atualiza todas as informa√ß√µes de um usu√°rio.                               |
| `PATCH`  | `/users/{id}` | Atualiza a senha de um usu√°rio.                                            |
| `DELETE` | `/users/{id}` | Realiza a exclus√£o l√≥gica de um usu√°rio (desativa o usu√°rio).              |

### Roles (`/roles` e Associa√ß√µes)

| M√©todo   | Endpoint                 | Descri√ß√£o                                 |
| :------- | :----------------------- | :---------------------------------------- |
| `POST`   | `/roles`                 | Cria uma nova role.                       |
| `GET`    | `/roles`                 | Lista todas as roles.                     |
| `GET`    | `/roles/{id}`            | Obt√©m os detalhes de uma role espec√≠fica. |
| `PUT`    | `/roles/{id}`            | Atualiza as informa√ß√µes de uma role.      |
| `DELETE` | `/roles/{id}`            | Exclui uma role.                          |
| `POST`   | `/users/{user_id}/roles` | Atribui uma ou mais roles a um usu√°rio.   |
| `DELETE` | `/users/{user_id}/roles` | Remove uma ou mais roles de um usu√°rio.   |

# üöÄ Guia de Desenvolvimento e Opera√ß√£o

Este guia cont√©m todas as instru√ß√µes necess√°rias para configurar, executar, testar e manter a qualidade do c√≥digo do projeto.

---

## üìã Requisitos do Sistema

Para compilar e executar este projeto, voc√™ precisar√° ter os seguintes softwares instalados em seu sistema:

- **Python**: A vers√£o `3.12` √© a utilizada no projeto.
- **Poetry**: O projeto utiliza Poetry para gerenciamento de depend√™ncias e ambientes virtuais.
- **Git**: Para clonar o reposit√≥rio e gerenciar o controle de vers√£o.

---

## üõ†Ô∏è Passo a Passo para Instala√ß√£o e Configura√ß√£o do Ambiente

Siga estas etapas para configurar o ambiente de desenvolvimento localmente.

1.  **Instale o Poetry**: Se voc√™ ainda n√£o tem o Poetry, instale-o. O m√©todo de instala√ß√£o recomendado pode ser encontrado na documenta√ß√£o oficial. O comando mais comum √©:

    ```bash
    curl -sSL [https://install.python-poetry.org](https://install.python-poetry.org) | python3 -
    ```

2.  **Clone o Reposit√≥rio**: Fa√ßa o clone do projeto do GitHub para a sua m√°quina local.

    ```bash
    git clone [https://github.com/pucrs-constrsw-2025-2/base.git](https://github.com/pucrs-constrsw-2025-2/base.git)
    cd base/backend/oauth
    ```

3.  **Instale as Depend√™ncias**: O Poetry ler√° o arquivo `pyproject.toml` e instalar√° todas as depend√™ncias necess√°rias, incluindo as de desenvolvimento como `pytest` e `ruff`.

    ```bash
    poetry install
    ```

    Este comando cria um ambiente virtual isolado para o projeto, garantindo que as depend√™ncias n√£o entrem em conflito com outros projetos.

4.  **Configure as Vari√°veis de Ambiente**: O projeto utiliza um arquivo `.env` para gerenciar segredos e configura√ß√µes de forma segura.
    - Copie o arquivo de exemplo `.env.example` para um novo arquivo chamado `.env`.
      ```bash
      cp .env.example .env
      ```
    - Abra o arquivo `.env` e preencha as vari√°veis com os valores corretos para o seu ambiente de desenvolvimento (URLs do Keycloak, credenciais, etc.).

---

## ‚ñ∂Ô∏è Passo a Passo para Execu√ß√£o em Desenvolvimento

Com o ambiente configurado, voc√™ pode iniciar o servidor da aplica√ß√£o.

1.  **Inicie o Servidor**: O projeto usa o `Uvicorn` como servidor ASGI para o `FastAPI`. O ponto de entrada da aplica√ß√£o √© `oauth_api/main.py`.

    - Execute o seguinte comando na raiz do projeto para iniciar o servidor em modo de desenvolvimento (com recarregamento autom√°tico ap√≥s altera√ß√µes no c√≥digo):
      ```bash
      poetry run uvicorn oauth_api.main:app --reload
      ```

2.  **Acesse a Aplica√ß√£o**: O servidor estar√° rodando. Voc√™ pode acessar a documenta√ß√£o interativa (Swagger UI), que √© gerada automaticamente pelo FastAPI, em seu navegador para testar os endpoints: `http://127.0.0.1:8000/docs`.

---

### üß™ Passo a Passo para Testes

O projeto est√° configurado com `pytest` para testes automatizados e `pytest-cov` para relat√≥rios de cobertura.

1.  **Execute a Su√≠te de Testes Completa**: Para rodar todos os testes unit√°rios e de integra√ß√£o, use o seguinte comando:

    ```bash
    poetry run pytest
    ```

2.  **Gere um Relat√≥rio de Cobertura**: Para executar os testes e ver um relat√≥rio de cobertura de c√≥digo no terminal, utilize:
    ```bash
    poetry run pytest --cov=oauth_api
    ```
    Isso mostrar√° quais partes do seu c√≥digo na pasta `oauth_api` foram cobertas pelos testes.

---

### üßπ Passo a Passo para Linting e Formata√ß√£o

Para garantir a qualidade e a consist√™ncia do c√≥digo, o projeto utiliza `Ruff` , `Black` e `MyPy`.

1.  **Verifique o C√≥digo com o Linter (Ruff)**: Para encontrar poss√≠veis erros, "code smells" e problemas de estilo, execute o Ruff.

    ```bash
    poetry run ruff check .
    ```

2.  **Verifique a Formata√ß√£o (Black)**: Para garantir que o c√≥digo segue um estilo consistente , voc√™ pode verificar a formata√ß√£o com o Black. O comando abaixo n√£o altera os arquivos, apenas informa se eles est√£o formatados corretamente.

    ```bash
    poetry run black . --check
    ```

    - Para formatar os arquivos automaticamente, remova a flag `--check`:
      ```bash
      poetry run black .
      ```

3.  **An√°lise Est√°tica de Tipos (MyPy)**: Para detectar erros de tipo antes da execu√ß√£o , use o MyPy.
    `bash
    poetry run mypy .
    `
    > **Nota**: Todas essas ferramentas est√£o configuradas para rodar automaticamente antes de cada `commit` atrav√©s do `pre-commit`, garantindo que o c√≥digo enviado ao reposit√≥rio mantenha sempre um alto padr√£o de qualidade.
